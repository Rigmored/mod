# Effects that help with making generated characters correct
#--------------------------------------------------------------------------------------
# trait removal

remove_disease_trait_effect = {
	remove_trait = pneumonic
	remove_trait = syphilitic
	remove_trait = leper
	remove_trait = has_tuberculosis
	remove_trait = has_typhoid_fever
	remove_trait = has_typhus
	remove_trait = has_bubonic_plague
	remove_trait = has_measles
	remove_trait = has_small_pox
	remove_trait = has_aztec_disease
	remove_trait = infection
	remove_trait = flu
	remove_trait = dysentery
	remove_trait = gout
	remove_trait = food_poisoning
	remove_trait = rabies
	remove_trait = cancer
	remove_trait = dancing_plague
	remove_trait = scurvy
	remove_trait = sick_incapable
	remove_trait = lovers_pox
}

remove_symptom_trait_effect = {
	remove_trait = cough
	remove_trait = fever
	remove_trait = diarrhea
	remove_trait = vomiting
	remove_trait = chest_pain
	remove_trait = cramps
	remove_trait = rash
	remove_trait = headache
	remove_trait = abdominal_pain
	remove_trait = fatigue
	remove_trait = malaise
}

remove_bad_mental_traits_effect = {
	remove_trait = stressed
	remove_trait = depressed
	remove_trait = lunatic
	remove_trait = possessed
}

remove_bad_physical_traits_effect = {
	remove_trait = ill
	remove_trait = wounded
	remove_trait = infirm
	remove_trait = incapable
	remove_trait = sickly
	remove_trait = is_fat
	remove_trait = is_malnourished
}

remove_scar_traits_effect = {
	remove_trait = eunuch
	remove_trait = blinded
	remove_trait = maimed
	remove_trait = scarred
	remove_trait = one_eyed
	remove_trait = one_handed
	remove_trait = one_legged
	remove_trait = disfigured
	remove_trait = mangled
	remove_trait = severely_injured
}

remove_bad_congenital_traits_effect = {
	remove_trait = clubfooted
	remove_trait = harelip
	remove_trait = hunchback
	remove_trait = lisp
	remove_trait = stutter
	remove_trait = ugly
	remove_trait = dwarf
	remove_trait = slow
	remove_trait = imbecile
	remove_trait = inbred
	remove_trait = weak
	remove_trait = giant
	remove_trait = deaf
	remove_trait = feeble
}

remove_learning_traits_effect = {
	remove_trait = amateurish_plotter
	remove_trait = flamboyant_schemer
	remove_trait = intricate_webweaver
	remove_trait = elusive_shadow
	remove_trait = naive_appeaser
	remove_trait = underhanded_rogue
	remove_trait = charismatic_negotiator
	remove_trait = grey_eminence
	remove_trait = indulgent_wastrel
	remove_trait = thrifty_clerk
	remove_trait = fortune_builder	
	remove_trait = midas_touched
	remove_trait = misguided_warrior
	remove_trait = tough_soldier
	remove_trait = skilled_tactician
	remove_trait = brilliant_strategist
	remove_trait = detached_priest
	remove_trait = martial_cleric
	remove_trait = scholarly_theologian
	remove_trait = mastermind_theologian
}

remove_wol_child_traits_effect = {
	remove_trait = haughty
	remove_trait = affectionate
	remove_trait = timid
	remove_trait = rowdy
	remove_trait = willful
	remove_trait = brooding
	remove_trait = indolent
	remove_trait = playful
	remove_trait = conscientious
	remove_trait = fussy
	remove_trait = curious
	remove_trait = idolizer
}

remove_bad_personality_traits_effect = {
	remove_trait = gluttonous
	remove_trait = greedy
	remove_trait = slothful
	remove_trait = envious
	remove_trait = wroth
	remove_trait = proud
	remove_trait = craven
	remove_trait = shy
	remove_trait = ambitious
	remove_trait = drunkard
	remove_trait = stubborn
	remove_trait = uncouth
	remove_trait = hedonist
	remove_trait = selfish
	remove_trait = rude
}
remove_vbad_personality_traits_effect = {
	remove_trait = ruthless
	remove_trait = deceitful
	remove_trait = arbitrary
	remove_trait = paranoid
}

remove_evil_personality_traits_effect = {
	remove_trait = cruel
	remove_trait = impaler
	remove_trait = cannibal_trait
	remove_trait = torturer
	remove_trait = blood_thirsty
}

remove_good_mental_traits_effect = {
	remove_trait = genius
	remove_trait = quick
	remove_trait = shrewd
	remove_trait = perceptive
}

remove_good_physical_traits_effect = {
	remove_trait = fair
	remove_trait = strong
	remove_trait = robust
	remove_trait = sturdy
	remove_trait = tall
	remove_trait = agile
}

remove_good_personality_traits_effect = {
	remove_trait = temperate
	remove_trait = charitable
	remove_trait = diligent
	remove_trait = kind
	remove_trait = patient
	remove_trait = humble
	remove_trait = honest
	remove_trait = brave
	remove_trait = gregarious
	remove_trait = content
	remove_trait = just
	remove_trait = trusting
	remove_trait = groomed
	remove_trait = animal_lover
	remove_trait = nature_lover
	remove_trait = honorable
}

remove_lifestyle_traits_effect = {
	remove_trait = gardener
	remove_trait = mystic
	remove_trait = duelist
	remove_trait = hunter
	remove_trait = falconer
	remove_trait = administrator
	remove_trait = architect
	remove_trait = strategist
	remove_trait = socializer
	remove_trait = schemer
	remove_trait = theologian
	remove_trait = gamer
	remove_trait = adventurer
	remove_trait = erudite
	remove_trait = animal_tongue
}

remove_sex_related_traits_effect = {
	remove_trait = homosexual
	remove_trait = celibate
	remove_trait = lustful
	remove_trait = chaste
	remove_trait = seducer
	remove_trait = seductress
	remove_trait = fertile
}

remove_extra_traits_effect = {
	remove_trait = cynical
	remove_trait = zealous
	remove_trait = dull
	remove_trait = melodious_voice
	remove_trait = powerful_voice
	remove_trait = dreamer
	remove_trait = absentminded
	remove_trait = imposing
	remove_trait = authoritative
}

# bastard, legit_bastard, child_of_consort, child_of_consort_male
# twin, pregnant, pregnancy_finishing, hard_pregnancy, troubled_pregnancy, annot_marry
# mujahid, crusader, excommunicated, born_in_the_purple
# heresiarch, monk, nun, on_pilgrimage, travelling, reincarnation
# in_hiding, disinherited, uncrowned
# pirate, ravager, seaking, sea_queen, shieldmaide, berserkern 	
# physician
# horse, house_dog, cat
# familial_kinslayer, dynastic_kinslayer, tribal_kinslayer, kinslayer
# bloodthirsty_gods_1, bloodthirsty_gods_2 , bloodthirsty_gods_3 

#--------------------------------------------------------------------------------------
# Many immortal species (Elves, Ents, Eagles) have an immortal_age = 40
# use this to get a properly immortal person of 40 or more
# Due to a bug, the fallback is to just add race_immortal
mep_age_to_immortal_effect = {
	if = { # bug workaround
		limit = { year >= 10000 }
		add_trait = race_immortal
	}
	else = {
		export_to_variable = { which = char_age value = age }
		subtract_variable = { which = char_age value = 40 }
		multiply_variable = { which = char_age value = -1 }
		add_age = char_age
		add_trait = race_immortal
		if = {
			limit = {
				NOT = { check_variable = { which = char_age value = 0 } }
			}
			multiply_variable = { which = char_age value = -1 }
			add_age = char_age
		}
	}
}

# In Middle-Earth, members of Immortal Races are commonly many thousands of years old
# Use this effect to add a random but large age to a young generated member of these Races
mep_add_immortal_age_effect = {
	# limit_age is used to prevent characters that are too old (date dependent)
	export_to_variable = { which = limit_age value = year }
	subtract_variable = { which = limit_age value = 1500 }
	# excess_age is part of working around the Y10K problem
	export_to_variable = { which = excess_age value = year } 
	subtract_variable = { which = excess_age value = 10000 }
	random_list = {
		5 = {
			add_age = 0
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 0 }
			}
		}
		10 = {
			add_age =  1000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 1000 }
			}
		}
		10 = {
			add_age =  2000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 2000 }
			}
		}
		10 = {
			add_age =  3000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 3000 }  # a start date before 13000 seems likely
			}
		}
		10 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 4000 } }
			}
			add_age =  4000
		}
		10 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 5000 } }
			}
			add_age =  5000
		}
		10 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 6000 } }
			}
			add_age =  6000
		}
		5 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 7000 } }
			}
			add_age =  7000
		}
		5 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 8000 } }
			}
			add_age =  8000
		}
		5 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 9000 } }
			}
			add_age =  9000
		}
		2 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 10000 } }
			}
			add_age = 10000
		}
	}
	random_list = {
		10 = { add_age = 0 }
		10 = { add_age = 100 }
		10 = { add_age = 200 }
		10 = { add_age = 300 }
		10 = { add_age = 400 }
		10 = { add_age = 500 }
		10 = { add_age = 600 }
		10 = { add_age = 700 }
		10 = { add_age = 800 }
		10 = { add_age = 900 }
	}
	random_list = {
		10 = { add_age = 0 }
		10 = { add_age = 10 }
		10 = { add_age = 20 }
		10 = { add_age = 30 }
		10 = { add_age = 40 }
		10 = { add_age = 50 }
		10 = { add_age = 60 }
		10 = { add_age = 70 }
		10 = { add_age = 80 }
		10 = { add_age = 90 }
	}
}

# Similar to mep_add_immortal_age_effect, but never really gets to over 7000
mep_add_immortal_age_effect_lesser = {
	# limit_age is used to prevent characters that are too old (date dependent)
	export_to_variable = { which = limit_age value = year }
	subtract_variable = { which = limit_age value = 1500 }
	# excess_age is part of working around the Y10K problem
	export_to_variable = { which = excess_age value = year } 
	subtract_variable = { which = excess_age value = 10000 }
	random_list = {
		10 = {
			add_age = 0
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 0 }
			}
		}
		10 = {
			add_age =  1000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 1000 }
			}
		}
		10 = {
			add_age =  2000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 2000 }
			}
		}
		10 = {
			add_age =  3000
			modifier = {
				factor = 0
				check_variable = { which = excess_age value = 3000 }  # a start date before 13000 seems likely
			}
		}
		10 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 4000 } }
			}
			add_age =  4000
		}
		5 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 5000 } }
			}
			add_age =  5000
		}
		5 = {
			modifier = {
				factor = 0
				NOT = { check_variable = { which = char_age value = 6000 } }
			}
			add_age =  6000
		}

	}
	random_list = {
		10 = { add_age = 0 }
		10 = { add_age = 100 }
		10 = { add_age = 200 }
		10 = { add_age = 300 }
		10 = { add_age = 400 }
		10 = { add_age = 500 }
		10 = { add_age = 600 }
		10 = { add_age = 700 }
		10 = { add_age = 800 }
		10 = { add_age = 900 }
	}
	random_list = {
		10 = { add_age = 0 }
		10 = { add_age = 10 }
		10 = { add_age = 20 }
		10 = { add_age = 30 }
		10 = { add_age = 40 }
		10 = { add_age = 50 }
		10 = { add_age = 60 }
		10 = { add_age = 70 }
		10 = { add_age = 80 }
		10 = { add_age = 90 }
	}
}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# used to apply the light_valinor trait if the scoped character is old enough
# should only be used on culture_amanyar (High Elves)
mep_check_add_light_valinor = {
	# Two Trees destroyed in year 4266
	export_to_variable = { which = ysince_tree value = year }
	subtract_variable = { which = ysince_tree value = 4267 }
	export_to_variable = { which = char_age value = age }
	# Checking and applying
	if = {
		limit = {
			check_variable = { which = char_age which = ysince_tree }
			NOT = { trait = light_valinor }
		}
		add_trait = light_valinor
	}
}

mep_apply_elven_traits = {
	remove_evil_personality_traits_effect = yes
	remove_bad_congenital_traits_effect = yes
	remove_bad_physical_traits_effect = yes
	random = {
		chance = 95
		remove_vbad_personality_traits_effect = yes
	}
	random = {
		chance = 50
		remove_bad_personality_traits_effect = yes
	}
	random_list = {
		10 = { add_trait = fea_strong }
		10 = { add_trait = fea_weak }
		80 = {}
	}
	random = {
		chance = 50
		add_trait = fair
	}
	random = {
		chance = 15
		add_trait = tall
	}
	random_list = {
		65 = {}
		20 = { add_trait = trained_elf }
		10 = { add_trait = great_elf   change_martial = 5 }
		5 = { add_trait = legendary_warrior  change_martial = 10 }
	}
}

mep_make_proper_elf_effect = {
	add_trait = elf
	mep_age_to_immortal_effect = yes
	mep_add_immortal_age_effect = yes
	if = {
		limit = { culture_group = culture_group_amanyar }
		mep_check_add_light_valinor = yes
	}
	mep_apply_elven_traits = yes
}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Generated characters have normal ages for humans. For Dwarves, we will scale these
# using (roughly) 16 -> 30, 60 -> 240, 110 -> 340
# Note: due to a bug, this works badly if the year > 10000
mep_scale_age_for_dwarf_effect = {
	# because generated ages are rather young
	random_list = {
		10 = { add_age = 2 }
		10 = { add_age = 3 }
		10 = { add_age = 4 }
		10 = { add_age = 5 }
		10 = { add_age = 6 }
		10 = { add_age = 7 }
		10 = { add_age = 8 }
		10 = { add_age = 9 }
	}
	export_to_variable = { which = char_age value = age }
	export_to_variable = { which = target_age value = age }
	log = "Age [char_age.GetValue]"
	# Children
	if = {
		limit = {
			NOT = { check_variable = { which = char_age value = 16 } }
		}
		multiply_variable = { which = target_age value = 1.875 }
	}
	# Adults
	else_if = {
		limit = {
			NOT = { check_variable = { which = char_age value = 60 } }
		}
		subtract_variable = { which = target_age value = 16 }
		multiply_variable = { which = target_age value = 4.7 }
		# the history files have much older Dwarves in the second age, but I'll decrease the effect here
		if = {
			limit = { year < 8400 }
			multiply_variable = { which = target_age value = 1.3 }
		}
		change_variable = { which = target_age value = 30 }
		log = "TargetAge [target_age.GetValue]"
	}
	# Elderly
	else = {
		subtract_variable = { which = target_age value = 60 }
		multiply_variable = { which = target_age value = 2 }
		if = {
			limit = { year < 8400 }
			change_variable = { which = target_age value = 300 }
		}
		else = {
			change_variable = { which = target_age value = 240 }
		}
	}
	# Changing the age
	subtract_variable = { which = target_age which = char_age }
	add_age = target_age
	set_variable = { which = char_age value = 0 }
	set_variable = { which = target_age value = 0 }
}

mep_make_proper_dwarf_effect = {
	add_trait = dwarven
	if = {
		limit = { year < 10000 }
		mep_scale_age_for_dwarf_effect = yes
	}
}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Life scaling for high blooded Númenóreans
# http://www.zarkanya.net/Tolkien/Decline%20of%20the%20Numenoreans.htm

# Scaling age for Númenóreans, uses global variables to get the scale
# Note that blood_of_numenor2 does not count for this 
mep_scale_age_numenorean_effect = {
	export_to_variable = { which = char_age value = age }
	set_variable = { which = target_age which = char_age }
	set_variable = { which = menopause_age value = 50 }
	# Royal (non black/adunaic)
	if = {
		limit = {
			OR = {
				trait = prince_numenor
				trait = blood_of_anarion
				trait = blood_of_isildur
			}
			NOT = { mep_is_black_numenorean_culture = yes }
		}
		multiply_variable = { which = target_age  which = global_agescale_numenorean_royal }
		multiply_variable = { which = menopause_age  which = global_agescale_numenorean_royal }
	}
	# Adûnaic / Black ( royalty, but for the 3rd age extended to all, since there is little difference )
	else_if = {
		limit = {
			mep_is_black_numenorean_culture = yes
			OR = {
				year > 8220
				AND = {
					year <= 8220
					trait = prince_numenor
				}
			}
		}
		multiply_variable = { which = target_age  which = global_agescale_numenorean_black }
		multiply_variable = { which = menopause_age  which = global_agescale_numenorean_black }
	}
	# For more ordinary full-blooded (blood_of_numenor or numenorean, not black)
	else = {
		multiply_variable = { which = target_age  which = global_agescale_numenorean_high }
		multiply_variable = { which = menopause_age  which = global_agescale_numenorean_high }
	}
	# We have a target age, we adjust
	subtract_variable = { which = target_age value = char_age }
	add_age = target_age
	# Checking if we should add the infertile trait
	if = {
		limit = {
			is_female = yes
			NOT = { trait = dunedain_infertility }
			age >= menopause_age
		}
		add_trait = dunedain_infertility
	}
}

# Adding the correct (non-royal) Númenórean trait
# Downfall in 8221
mep_apply_numenorean_trait_effect = {
	if = {
		limit = { year < 8700 }
		# Getting Date of Birth
		export_to_variable = { which = char_age value = age }
		export_to_variable = { which = year_born value = year }
		subtract_variable = { which = year_born  which = char_age }
		# If born early enough, always born in Númenor
		if = {
			limit = {
				NOT = { check_variable = { which = year_born value = 8200 } }
			}
			add_trait = numenorean
		}
	}
}

# Apply Númenórean traits and aging to a generated character
mep_make_proper_numenorean_effect = {
	# First, 'True Blood' or 'Strong Traces' ?
	if = {
		limit = { year < 8550 }
		add_trait = blood_of_numenor
	}
	else = {
		if = {
			limit = { year >= 11350 }
			random_list = {
				10 = { add_trait = blood_of_numenor }
				90 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 11000 }
			random_list = {
				20 = { add_trait = blood_of_numenor }
				80 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 10650 }
			random_list = {
				30 = { add_trait = blood_of_numenor }
				70 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 10300 }
			random_list = {
				40 = { add_trait = blood_of_numenor }
				60 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 9950 }
			random_list = {
				50 = { add_trait = blood_of_numenor }
				50 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 9600 }
			random_list = {
				60 = { add_trait = blood_of_numenor }
				40 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 9250 }
			random_list = {
				70 = { add_trait = blood_of_numenor }
				30 = { add_trait = blood_of_numenor2 }
			}
		}
		else_if = {
			limit = { year >= 8900 }
			random_list = {
				80 = { add_trait = blood_of_numenor }
				20 = { add_trait = blood_of_numenor2 }
			}
		}
		else = {
			random_list = {
				90 = { add_trait = blood_of_numenor }
				10 = { add_trait = blood_of_numenor2 }
			}
		}
	}
	if = {
		limit = { trait = blood_of_numenor }
		# Second, apply the age scaling (before Y10K, because doing it after is buggy)
		if = {
			limit = { year < 10015 }
			mep_scale_age_numenorean_effect = yes
		}	
		# Third, possible numenorean trait
		mep_apply_numenorean_trait_effect = yes
	}
}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Orcs: note: many Orcs seem to live longer than Humans

mep_apply_orc_traits_effect = {
	remove_lifestyle_traits_effect = yes
	random = {
		chance = 50
		remove_good_mental_traits_effect = yes
	}
	random = {
		chance = 90
		remove_good_personality_traits_effect = yes
	}
	random_list = {
		20 = {
			modifier = {
				factor = 0.333
				OR = {
					culture = culture_urukhai
					culture = culture_kul_uruk
				}
			}
			modifier = {
				factor = 2
				culture = culture_goblin
			}
			add_trait = weak_orc
		}
		30 = {}
		25 = { add_trait = orc_warrior }
		15 = { add_trait = strong_orc }
		5 = {
			modifier = {
				factor = 0.5
				culture = culture_goblin
			}
			modifier = {
				factor = 2
				OR = {
					culture = culture_urukhai
					culture = culture_kul_uruk
				}
			}
			add_trait = great_orc
		}
	}
}

mep_make_proper_orc_effect = {
	add_trait = orc
	mep_apply_orc_traits_effect = yes
}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Wilderness (Strip Everything!)

mep_make_proper_wilderness_effect = {
	remove_bad_mental_traits_effect = yes
	remove_bad_physical_traits_effect = yes
	remove_scar_traits_effect = yes
	remove_bad_congenital_traits_effect = yes
	remove_learning_traits_effect = yes
	remove_bad_personality_traits_effect = yes
	remove_vbad_personality_traits_effect = yes
	remove_evil_personality_traits_effect = yes
	remove_good_mental_traits_effect = yes
	remove_good_physical_traits_effect = yes
	remove_good_personality_traits_effect = yes
	remove_lifestyle_traits_effect = yes
	remove_sex_related_traits_effect = yes
	remove_extra_traits_effect = yes
	add_trait = wilderness
}
